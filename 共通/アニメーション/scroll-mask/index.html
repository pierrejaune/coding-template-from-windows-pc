<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>マスク内パララックス（修正版）</title>

    <style>
      body {
        margin: 0;
        padding: 0;
        height: 300vh;
        background: #f5f5f5;
        font-family: sans-serif;
      }

      .sec {
        padding: 50vh 0;
        position: relative;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* マスクエリア */
      .sec__img {
        position: relative;
        width: 345px;
        height: 435px;
        overflow: hidden;
        mask-image: url('./img/mask-ellipse.png');
        -webkit-mask-image: url('./img/mask-ellipse.png');
        mask-size: contain;
        -webkit-mask-size: contain;
        mask-repeat: no-repeat;
        -webkit-mask-repeat: no-repeat;
        mask-position: center;
        -webkit-mask-position: center;
        background: #ddd;
      }

      .sec__img img {
        position: absolute;
        object-fit: cover;
        transform: translate(0, 0);
        will-change: transform;
      }

      .sec__img.up img {
        top: 0;
        left: 50%;
        transform: translateX(-50%);
      }

      .sec__img.toRight img {
        top: 50%;
        left: 0;
        transform: translateY(-50%);
      }
    </style>
  </head>

  <body>
    <section class="sec">
      <div class="sec__img up">
        <img src="https://picsum.photos/id/1018/600/900" alt="vertical" />
      </div>
    </section>

    <section class="sec">
      <div class="sec__img toRight">
        <img src="https://picsum.photos/id/1025/900/600" alt="horizontal" />
      </div>
    </section>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('.sec__img');

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              entry.target.classList.toggle('inview', entry.isIntersecting);
            });
          },
          { threshold: 0.1 }
        );
        sections.forEach((s) => observer.observe(s));

        const moveRanges = new WeakMap();

        function updateRanges() {
          sections.forEach((sec) => {
            const img = sec.querySelector('img');
            const maskW = sec.offsetWidth;
            const maskH = sec.offsetHeight;

            // マスクの1.1倍サイズで設定
            if (sec.classList.contains('up')) {
              img.style.width = `${maskW * 1}px`;
              img.style.height = `${maskH * 1.1}px`;
            } else if (sec.classList.contains('toRight')) {
              img.style.width = `${maskW * 1.1}px`;
              img.style.height = `${maskH * 1}px`;
            }

            // 実際の描画サイズ
            const renderedW = img.clientWidth;
            const renderedH = img.clientHeight;
            const move = sec.classList.contains('up')
              ? renderedH - maskH
              : renderedW - maskW;

            moveRanges.set(sec, move);
          });
        }

        window.addEventListener('load', updateRanges);
        window.addEventListener('resize', updateRanges);

        window.addEventListener('scroll', () => {
          const winH = window.innerHeight;

          sections.forEach((sec) => {
            if (!sec.classList.contains('inview')) return;

            const rect = sec.getBoundingClientRect();
            const progress = 1 - rect.top / winH;
            const img = sec.querySelector('img');
            const move = moveRanges.get(sec) || 0;
            const clamped = Math.max(0, Math.min(progress, 1));

            if (sec.classList.contains('up')) {
              // 上→下
              img.style.transform = `translate(-50%, ${-move * clamped}px)`;
            } else if (sec.classList.contains('toRight')) {
              // 右→左（修正済み）
              img.style.transform = `translate(${-move * clamped}px, -50%)`;
            }
          });
        });
      });
    </script>
  </body>
</html>
