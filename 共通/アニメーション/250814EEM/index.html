<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!-- リファクタリング前 -->
    <script>
      $(function () {
        $(window).on('load scroll', function () {
          var isAnySectionVisible = false;

          $('.bg_color').each(function () {
            var imgPos = $(this).offset().top;
            var scroll = $(window).scrollTop();
            var windowHeight = $(window).height();
            var elementHeight = $(this).outerHeight();
            var elementBottom = imgPos + elementHeight;
            var triggerTop = imgPos - windowHeight * (1 / 4);

            // .bg_color__last
            var isLastElement = $(this).hasClass('bg_color__last');
            var triggerBottom;

            if (isLastElement) {
              // .bg_color__lastの場合
              triggerBottom = null;
            } else {
              // 通常の計算
              triggerBottom = imgPos + elementHeight - windowHeight * (1 / 3);
            }

            if (isLastElement) {
              // .bg_color__lastの場合
              if (scroll > triggerTop) {
                isAnySectionVisible = true;
              }
            } else {
              if (scroll > triggerTop && scroll < triggerBottom) {
                isAnySectionVisible = true;
              }
            }
          });

          if (isAnySectionVisible) {
            $('.feature_bg').addClass('active');
          } else {
            $('.feature_bg').removeClass('active');
          }
        });
      });
    </script>

    <!-- リファクタリング後 -->
    <script>
      $(function () {
        const $window = $(window);
        const $featureBg = $('.feature_bg');
        const $bgSections = $('.bg_color');

        const toggleFeatureBg = () => {
          const scroll = $window.scrollTop();
          const windowHeight = $window.height();
          let isAnySectionVisible = false;

          $bgSections.each(function () {
            const $el = $(this);
            const offsetTop = $el.offset().top;
            const elementHeight = $el.outerHeight();
            const isLast = $el.hasClass('bg_color__last');

            const triggerTop = offsetTop - windowHeight * 0.25;
            const triggerBottom = isLast
              ? Infinity
              : offsetTop + elementHeight - windowHeight * (1 / 3);

            if (scroll > triggerTop && scroll < triggerBottom) {
              isAnySectionVisible = true;
              return false; // 1つでも見つかればループ終了
            }
          });

          $featureBg.toggleClass('active', isAnySectionVisible);
        };

        $window.on('load scroll', toggleFeatureBg);
      });
    </script>
  </body>
</html>
