<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>完成版 GSAP Sticky + After-pin padding Demo</title>

    <!-- GSAP & ScrollTrigger 読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <style>
      body {
        margin: 0;
        background: #f5f5f5;
        font-family: sans-serif;
      }

      /* 各セクション */
      .sec__area {
        position: relative;
      }

      /* ピン留め領域 */
      .sec__pin {
        position: relative;
        background: #fff;
        overflow: hidden;
      }

      .sec__pin-box {
        position: relative;
        height: 50vh;
        overflow: hidden;
      }

      /* スクロールで切り替わる画像 */
      .sec__img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        top: 0;
        left: 0;
      }

      /* 後続のコンテンツ（sec__pin内にある） */
      .after-pin {
        width: 80%;
        max-width: 800px;
        margin: 0 auto;
        height: 400px;
        background: #ffe0b2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: #333;
        transition: all 0.5s ease;
      }

      /* onクラスが付与されたら配置変更 */
      .sec__pin.on .after-pin {
        position: absolute;
        left: 50%;
        bottom: 0%;
        transform: translate(-50%, 0%);
        background-color: #ffe0b2;
      }

      /* デモ用：次のコンテンツ */
      .next-content {
        height: 100vh;
        background: #c8ffc8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
      }
    </style>

    <script>
      // --------------------------------------------
      // GSAPで画像せり上がり＋after-pin padding処理
      // --------------------------------------------
      document.addEventListener('DOMContentLoaded', () => {
        gsap.registerPlugin(ScrollTrigger);

        function setupStickyImageScroll() {
          const hasLeft = document.querySelector('.f-left') !== null;
          const topOffset = hasLeft ? 80 : 52;

          const pinSections = document.querySelectorAll('.sec__pin');

          pinSections.forEach((pinSection) => {
            const section = pinSection.closest('.sec__area');
            const bg = pinSection.querySelector('.sec__pin-box');
            const imgs = bg.querySelectorAll('.sec__img');
            const afterPin = section.querySelector('.after-pin');

            if (!section || !bg || imgs.length === 0 || !afterPin) return;

            const imgCount = imgs.length;
            const imgHeight = imgs[0].offsetHeight;
            const scrollLength = imgHeight * (imgCount - 1);

            // ------------------------------
            // after-pin の高さを取得して sec__pin に padding-bottom を付与
            // ------------------------------
            function updatePaddingAndClass() {
              const afterPinHeight = afterPin.offsetHeight;
              pinSection.style.paddingBottom = afterPinHeight + 'px';
              pinSection.classList.add('on');
            }

            // 初期化およびリサイズ時に再実行
            window.addEventListener('load', updatePaddingAndClass);
            window.addEventListener('resize', updatePaddingAndClass);

            // ------------------------------
            // ピン留め設定
            // ------------------------------
            ScrollTrigger.create({
              trigger: pinSection,
              start: `top-=${topOffset}px top`,
              end: `+=${scrollLength}`,
              pin: pinSection,
              pinSpacing: true,
              anticipatePin: 1.5,
              invalidateOnRefresh: true,
              onEnter: () => {
                // bg.style.top = `${topOffset}px`;
                afterPin.classList.add('showed');
                // section.classList.add('on');
              },
              onLeave: () => {
                afterPin.classList.remove('showed');
                // section.classList.remove('on');
              },
              onEnterBack: () => {
                bg.style.top = `${topOffset}px`;
                afterPin.classList.add('showed');
                // section.classList.add('on');
              },
              onLeaveBack: () => {
                afterPin.classList.remove('showed');
                // section.classList.remove('on');
              },
            });

            // ------------------------------
            // 2枚目以降の画像を下からスライド
            // ------------------------------
            imgs.forEach((img, i) => {
              if (i === 0) return;
              gsap.fromTo(
                img,
                { yPercent: 100, force3D: true },
                {
                  yPercent: 0,
                  ease: 'power1.out',
                  scrollTrigger: {
                    trigger: section,
                    start: `top-=${topOffset - imgHeight * (i - 1)} top`,
                    end: `top-=${topOffset - imgHeight * i} top`,
                    scrub: 0.5,
                    invalidateOnRefresh: true,
                  },
                }
              );
            });
          });
        }

        setupStickyImageScroll();
      });
    </script>
  </head>
  <body>
    <!-- 前のコンテンツ -->
    <section
      class="content01"
      style="
        height: 100vh;
        background: #d0e6ff;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <h1>前のコンテンツ</h1>
    </section>

    <!-- メインエリア -->
    <section class="sec__area">
      <div class="sec__pin">
        <div class="sec__pin-box">
          <img
            src="https://picsum.photos/seed/img1/1200/800"
            class="sec__img"
          />
          <img
            src="https://picsum.photos/seed/img2/1200/800"
            class="sec__img"
          />
          <img
            src="https://picsum.photos/seed/img3/1200/800"
            class="sec__img"
          />
        </div>

        <!-- 固定解除後に見せたい after-pin -->
        <div class="after-pin">次のコンテンツがここに見える！</div>
      </div>
    </section>

    <section class="sec__area">
      <div class="sec__pin">
        <div class="sec__pin-box">
          <img
            src="https://picsum.photos/seed/img1/1200/800"
            class="sec__img"
          />
          <img
            src="https://picsum.photos/seed/img2/1200/800"
            class="sec__img"
          />
          <img
            src="https://picsum.photos/seed/img3/1200/800"
            class="sec__img"
          />
        </div>

        <!-- 固定解除後に見せたい after-pin -->
        <div class="after-pin">次のコンテンツがここに見える！</div>
      </div>
      <p>普通のコンテンツ</p>
    </section>

    <!-- 後続のコンテンツ -->
    <section class="next-content">
      <p>後ろのセクション</p>
    </section>
  </body>
</html>
